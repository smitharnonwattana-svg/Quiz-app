<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Science Practice v14</title>
  <style>
    :root{--border:#e5e7eb;--muted:#6b7280;--bg:#f9fafb;--black:#111827;--ok:#16a34a;--warn:#f59e0b;}
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans Thai","Noto Sans","Liberation Sans";color:#111;background:#fff;}
    a{color:inherit;text-decoration:none;}
    .container{max-width:1200px;margin:0 auto;padding:24px;}
    .h1{font-size:22px;font-weight:900;margin:0;}
    .h2{font-size:16px;font-weight:900;margin:0;}
    .muted{color:var(--muted);font-size:12px;}
    .card{border:1px solid var(--border);border-radius:14px;background:#fff;}
    .linkCard{padding:16px;border:1px solid var(--border);border-radius:14px;background:#fff;display:block;cursor:pointer;}
    .linkCard:hover{background:var(--bg);}
    .btn{border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:14px;font-family:inherit;}
    .btnPrimary{background:var(--black);border-color:var(--black);color:#fff;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .list{display:grid;gap:12px;margin-top:16px;}
    .tableWrap{overflow:auto;border:1px solid var(--border);border-radius:14px;margin-top:16px;}
    table{border-collapse:collapse;width:100%;font-size:13px;min-width:760px;}
    th,td{padding:10px 12px;border-top:1px solid var(--border);vertical-align:top;text-align:left;}
    thead th{background:var(--bg);border-top:none;position:sticky;top:0;z-index:1;}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);}
    .badge.ok{background:#dcfce7;border-color:#bbf7d0;color:#166534;}
    .badge.warn{background:#fffbeb;border-color:#fde68a;color:#92400e;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .hr{height:1px;background:var(--border);margin:14px 0;}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(8px);transition:.2s;font-size:13px;z-index:9999;}
    .toast.show{opacity:1;transform:translateY(0);}
    .page{display:none;}
    .page.active{display:block;}

    /* take page */
    /* Desktop layout */
    .takeRoot{height:100vh;width:100vw;overflow:hidden;}
    .takeGrid{height:100%;display:grid;grid-template-columns:8fr 2fr;}
    .takeLeft{border-right:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;}
    .takeRight{overflow:auto;-webkit-overflow-scrolling:touch;background:#fff;}
    .stickyBar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .choice{display:flex;align-items:center;justify-content:center;gap:0;border:2px solid var(--border);border-radius:10px;padding:8px 0;cursor:pointer;transition:all .15s;background:#fff;font-weight:900;font-size:15px;min-width:0;}
    .choice:hover{border-color:#9ca3af;background:#f9fafb;}
    .choice.active{border-color:var(--black);background:var(--black);color:#fff;}
    .gridNums{display:flex;flex-wrap:wrap;gap:6px;}
    .numBtn{width:34px;height:34px;padding:0;border-radius:8px;font-size:11px;font-weight:700;transition:all .12s;}
    .iframePdf{width:100%;height:calc(100vh - 56px);border:none;display:block;}
    .pdfWrapTake{flex:1;min-height:0;position:relative;display:flex;flex-direction:column;}
    .pdfOverlay{position:absolute;inset:56px 0 0 0;background:rgba(17,24,39,.65);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;padding:18px;}
    .pdfOverlayInner{background:#fff;border-radius:16px;padding:16px;max-width:420px;width:100%;border:1px solid var(--border);}
    .pdfOverlayInner .title{font-weight:900;font-size:16px;}
    .pdfOverlayInner .desc{margin-top:6px;color:var(--muted);font-size:13px;}
    .pdfOverlayInner .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;}
    .pdfOverlay.hide{display:none;}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

    /* ‚ïê‚ïê DESKTOP: side-by-side ‚ïê‚ïê */
    @media (min-width: 901px) {
      .takeRoot{height:100vh;overflow:hidden;}
      .takeGrid{height:100%;display:grid;grid-template-columns:8fr 2fr;}
      .takeLeft{border-right:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;}
      .takeRight{overflow:auto;}
    }

    /* ‚ïê‚ïê MOBILE: PDF 80% top, controls 20% bottom ‚ïê‚ïê */
    @media (max-width: 900px) {
      /* takeRoot ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
      .takeRoot{height:100vh;overflow:hidden;}
      .takeGrid{height:100%;display:flex;flex-direction:column;}

      /* PDF zone: 80% */
      .takeLeft{
        flex:0 0 80vh;
        height:80vh;
        border-right:none;
        border-bottom:2px solid var(--border);
        overflow:hidden;
        display:flex;flex-direction:column;
      }
      /* ‡∏ã‡πà‡∏≠‡∏ô title bar ‡∏ã‡πâ‡∏≤‡∏¢ (‡∏ä‡∏∑‡πà‡∏≠ exam + ‡πÄ‡∏ß‡∏•‡∏≤) ‚Äî ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
      .takeLeft .stickyBar{display:none;}

      /* Controls zone: 20vh fixed ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà ‡∏Å ‡∏Ç ‡∏Ñ ‡∏á + prev/unsure/next */
      .takeRight{
        flex:0 0 20vh;
        height:20vh;
        overflow:hidden;
        background:#fff;
        border-top:1px solid var(--border);
      }

      /* ‡∏ã‡πà‡∏≠‡∏ô stickyBar (‡∏Ç‡πâ‡∏≠/‡πÄ‡∏ß‡∏•‡∏≤/‡∏≠‡∏≠‡∏Å/‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö) */
      .takeRight .stickyBar{display:none !important;}

      /* ‡∏ã‡πà‡∏≠‡∏ô label "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö" ‡πÅ‡∏•‡∏∞ grid ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ */
      .takeNumsWrap { display:none !important; }
      .takeRight > div > .muted { display:none !important; }

      /* content wrapper ‚Äî flex column ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á */
      .takeRight > div {
        padding:6px 10px !important;
        gap:5px !important;
        display:flex !important;
        flex-direction:column !important;
        justify-content:center !important;
        height:100%;
        box-sizing:border-box;
      }

      /* choice grid 2x2 ‡∏™‡∏π‡∏á‡∏û‡∏≠‡∏î‡∏µ */
      #takeChoices{
        gap:4px !important;
        flex:1;
        min-height:0;
      }
      .choice{
        padding:0 4px !important;
        font-size:15px !important;
        border-radius:10px !important;
        min-height:0 !important;
        height:100%;
        align-items:center;
        justify-content:center;
      }

      /* ‡∏õ‡∏∏‡πà‡∏° prev/unsure/next */
      #takePrevBtn,#takeUnsureBtn,#takeNextBtn{
        padding:3px 10px !important;
        font-size:11px !important;
        border-radius:8px !important;
      }

      /* pdfOverlay ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
      .pdfOverlay{position:fixed;inset:0;z-index:200;}

      /* review page */
      #reviewPdfViewer{min-height:300px;}
    }

    /* review page */
    .reviewLayout{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start;}
    .examGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:16px;}
    .examCard{background:#fff;border:1px solid var(--border);border-radius:16px;padding:18px;cursor:pointer;transition:all .15s;display:flex;flex-direction:column;gap:8px;}
    .examCard:hover{border-color:#6b7280;box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-1px);}
    .examCard .subj{display:inline-block;background:#f3f4f6;border-radius:99px;padding:3px 10px;font-size:12px;font-weight:700;color:#374151;}
    .examCard .title{font-weight:900;font-size:15px;line-height:1.4;}
    .examCard .meta{display:flex;gap:12px;font-size:12px;color:var(--muted);margin-top:2px;}
    .examCard .score-badge{margin-top:6px;padding:6px 10px;background:#f9fafb;border-radius:8px;font-size:12px;border:1px solid var(--border);}
    @media(max-width:980px){.reviewLayout{grid-template-columns:1fr;}.reviewSide{position:static!important;}}
    .reviewPdfWrap{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#fff;display:flex;flex-direction:column;height:90vh;}
    .reviewPdfBar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);}
    .reviewSide{position:sticky;top:12px;}
    .reviewCard{border:1px solid var(--border);border-radius:16px;background:#fff;padding:12px;}
    .chips{display:flex;flex-wrap:wrap;gap:6px;}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-family:inherit;}
    .chip.bad{border-color:#ef4444;color:#b91c1c;background:#fff5f5;}
    .chip.good{border-color:#22c55e;color:#166534;background:#f0fdf4;}
    .wrongText{font-size:15px;line-height:1.4;}
    .wrongText .label{color:#6b7280;}
    .wrongText .list{color:#b91c1c;font-weight:800;}
    .qListReview{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
    .qItem{border:1px solid var(--border);border-radius:16px;padding:10px;}
    .qHead{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .qBadge{border-radius:999px;padding:4px 10px;font-weight:600;border:1px solid var(--border);}
    .qBadge.good{border-color:#22c55e;color:#166534;background:#f0fdf4;}
    .qBadge.bad{border-color:#ef4444;color:#b91c1c;background:#fff5f5;}
    .opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
    @media(max-width:980px){.opts{grid-template-columns:1fr;}}
    .opt{border:1px solid var(--border);border-radius:14px;padding:10px;min-height:44px;display:flex;gap:10px;align-items:flex-start;}
    .optKey{width:26px;height:26px;border-radius:999px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 auto;}
    .opt.correct{border-color:#22c55e;background:#f0fdf4;}
    .opt.correct .optKey{border-color:#22c55e;color:#166534;}
    .opt.chosen.bad{border-color:#ef4444;background:#fff5f5;}
    .opt.chosen.bad .optKey{border-color:#ef4444;color:#b91c1c;}
    .opt.chosen.good{border-color:#22c55e;background:#f0fdf4;}
    .opt .tag{margin-left:auto;font-size:12px;font-weight:700;opacity:.9;}

    /* stats page */
    .stats-table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;}
    .stats-table th,.stats-table td{padding:14px 16px;vertical-align:top;border-top:1px solid #e9eef7;}
    .stats-table thead th{background:#fbfcff;font-weight:700;}
    .stats-table thead th:first-child{border-top-left-radius:18px;}
    .stats-table thead th:last-child{border-top-right-radius:18px;}
    .stats-table tbody tr:last-child td:first-child{border-bottom-left-radius:18px;}
    .stats-table tbody tr:last-child td:last-child{border-bottom-right-radius:18px;}
    .stats-table td small{display:block;color:#6b7280;margin-top:6px;word-break:break-all;}
    .btn-delete{border:1px solid rgba(239,68,68,.55);color:#b91c1c;background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:700;}
    .btn-delete:hover{background:rgba(239,68,68,.08);}
    .modal-overlay{position:fixed;inset:0;background:rgba(17,24,39,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999;}
    .modal-overlay.show{display:flex;}
    .modal{background:#fff;border-radius:18px;width:min(520px,96vw);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.18);}
    .modal h3{margin:0 0 8px;font-size:18px;}
    .modal p{margin:0 0 14px;color:#4b5563;}
    .modal .mrow{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
    .btn-ghost{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:700;}
    .btn-danger{border:1px solid rgba(239,68,68,.55);background:#ef4444;color:#fff;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:800;}

    /* admin editor */
    textarea{width:100%;min-height:64px;resize:vertical;font-family:inherit;}
    input[type="number"]{width:72px;}
    .tableBox{overflow:auto;max-height:calc(100vh - 210px);}
    .bar2{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;background:#fff;}
    .rowActive{background:#f3f4f6;}
    .ctrls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .titleInput{min-width:260px;max-width:520px;width:38vw;padding:8px 10px;border:1px solid var(--border);border-radius:10px;font-family:inherit;}
    .correctBtns{display:flex;gap:4px;}
    .correctBtn{width:34px;height:30px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-weight:700;font-size:13px;font-family:inherit;transition:all .12s;}
    .correctBtn:hover{border-color:#9ca3af;background:#f3f4f6;}
    .correctBtn.selected{background:var(--black);border-color:var(--black);color:#fff;}
  </style>
  <!-- PDF.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Setup PDF.js worker
    if(typeof pdfjsLib !== 'undefined'){
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- ===================== PAGE: HOME ===================== -->
<div id="page-home" class="page active">
  <div class="container">
    <h1 class="h1">Science Practice</h1>
    <p class="muted" style="margin-top:8px;">‡πÄ‡∏î‡πÇ‡∏° HTML ‡∏•‡πâ‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ server/db) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ UI ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö</p>
    <div class="list">
      <div class="linkCard" onclick="navigate('exams')">
        <div style="font-weight:900;">1) ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>
        <div class="muted" style="margin-top:6px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥ (PDF + timer)</div>
      </div>
      <div class="linkCard" onclick="navigate('stats')">
        <div style="font-weight:900;">2) ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
        <div class="muted" style="margin-top:6px;">‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage)</div>
      </div>
      <div class="linkCard" onclick="navigate('admin')">
        <div style="font-weight:900;">3) Admin</div>
        <div class="muted" style="margin-top:6px;">‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö + preview PDF + ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏£‡πá‡∏ß</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏î‡πÇ‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå (localStorage) ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á Android ‡πÅ‡∏•‡∏∞ iOS</div>
  </div>
</div>

<!-- ===================== PAGE: EXAMS ===================== -->
<div id="page-exams" class="page">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
      <div>
        <h1 class="h1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h1>
        <div class="muted" style="margin-top:6px;">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥</div>
      </div>
      <button class="btn" onclick="navigate('home')">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
    <div class="card" style="padding:12px;margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <span class="muted">‡∏ß‡∏¥‡∏ä‡∏≤</span>
      <select id="examsSubjFilter" class="btn" style="padding:10px 12px;min-width:240px;"></select>
    </div>
    <div id="examsList" class="list"></div>
  </div>
</div>

<!-- ===================== PAGE: EXAM DETAIL ===================== -->
<div id="page-exam" class="page">
  <div class="container" style="max-width:900px;">
    <div id="examDetailWrap"></div>
    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn" onclick="navigate('exams')">‡∏Å‡∏•‡∏±‡∏ö</button>
      <button class="btn" onclick="navigate('home')">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===================== PAGE: TAKE ===================== -->
<div id="page-take" class="page">
  <div class="takeRoot">
    <div class="takeGrid">
      <div class="takeLeft">
        <div class="stickyBar">
          <div>
            <div id="takeExamTitle" style="font-weight:900;">Exam</div>
            <div class="muted" id="takePdfPage">PDF ‡∏´‡∏ô‡πâ‡∏≤ -</div>
          </div>
          <div style="font-weight:900;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span id="takeTimer">--:--</span></div>
        </div>
        <div class="pdfWrapTake">
          <div id="takePdfViewer" style="width:100%;height:100%;position:relative;flex:1;min-height:0;"></div>

        </div>
      </div>
      <div class="takeRight">
        <div class="stickyBar">
          <div>
            <div style="font-weight:900;">‡∏Ç‡πâ‡∏≠ <span id="takeQNo">-</span> / <span id="takeQTotal">-</span></div>
            <div class="muted">‡πÄ‡∏ß‡∏•‡∏≤ <span id="takeTimer2">--:--</span></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button class="btn" id="takeExitBtn" style="padding:8px 12px;">‡∏≠‡∏≠‡∏Å</button>
            <button class="btn btnPrimary" id="takeSubmitBtn" disabled>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
          </div>
        </div>
        <div style="padding:12px;display:grid;gap:10px;">
          <div class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</div>
          <div id="takeChoices" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
            <button class="btn" id="takePrevBtn" style="padding:6px 10px;font-size:12px;">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <button class="btn" id="takeUnsureBtn" style="padding:6px 10px;font-size:12px;">‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à</button>
            <button class="btn" id="takeNextBtn" style="padding:6px 10px;font-size:12px;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
          </div>
          <div class="takeNumsWrap" style="margin-top:6px;">
            <div class="muted" style="margin-bottom:8px;">‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠</div>
            <div id="takeNums" class="gridNums"></div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== PAGE: REVIEW ===================== -->
<div id="page-review" class="page">
  <div class="container" style="max-width:1200px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin:14px 0 10px;">
      <div>
        <div style="font-size:26px;font-weight:800;" id="reviewTitle">‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</div>
        <div class="muted" id="reviewSub"></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="btn" onclick="navigate('stats')">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
        <button class="btn" onclick="navigate('home')">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      </div>
    </div>
    <div class="reviewLayout">
      <div class="reviewPdfWrap">
        <div class="reviewPdfBar">
          <div style="font-weight:700;" id="reviewPdfLabel">PDF</div>
          <div class="muted" style="font-size:12px;">(‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÉ‡∏ô PDF ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</div>
        </div>
        <div id="reviewPdfViewer" style="width:100%;flex:1;min-height:400px;position:relative;"></div>
      </div>
      <div class="reviewSide" style="position:sticky;top:12px;">
        <div class="reviewCard">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
            <div>
              <div style="font-weight:800;" id="reviewScore">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -/-</div>
              <div class="muted" id="reviewMeta"></div>
              <div style="margin-top:6px;font-weight:700;" id="reviewSummaryLine"></div>
            </div>
            <button class="btn" id="reviewScrollTop">‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô</button>
          </div>
          <div style="margin-top:10px;">
            <div id="reviewWrongListText" class="wrongText"></div>
          </div>
        </div>
        <div class="reviewCard" style="margin-top:12px;">
          <div class="muted" style="margin-bottom:6px;">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠</div>
          <div class="chips" id="reviewNavChips"></div>
        </div>
      </div>
    </div>
    <div class="qListReview" id="reviewQList"></div>
  </div>
</div>

<!-- ===================== PAGE: STATS ===================== -->
<div id="page-stats" class="page">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
      <div>
        <h1 class="h1">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h1>
        <div class="muted">‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="navigate('home')">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        <button class="btn btnPrimary" onclick="navigate('exams')">‡πÑ‡∏õ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
      </div>
    </div>
    <div class="card" style="padding:16px;margin-top:16px;">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span class="muted" style="white-space:nowrap;">‡∏ß‡∏¥‡∏ä‡∏≤</span>
          <select id="statsFilterSubject" class="btn" style="padding:10px 12px;min-width:220px;"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
          <span class="muted" style="white-space:nowrap;">‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</span>
          <select id="statsFilterExam" class="btn" style="padding:10px 12px;min-width:260px;"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <button id="statsBtnExport" class="btn btnPrimary">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
          <label class="btn">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥<input id="statsFileImport" type="file" accept="application/json" style="display:none;" /></label>
          <button id="statsBtnClear" class="btn">‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
        </div>
      </div>
      <div style="overflow:auto;">
        <table class="stats-table" style="min-width:900px;">
          <thead>
            <tr>
              <th style="width:60px;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</th>
              <th style="width:200px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥</th>
              <th style="width:160px;">‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
              <th style="width:140px;">‡∏ß‡∏¥‡∏ä‡∏≤</th>
              <th>‡∏ä‡∏∏‡∏î</th>
              <th style="width:110px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
              <th style="width:110px;">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
              <th style="width:100px;"></th>
            </tr>
          </thead>
          <tbody id="statsRows">
            <tr><td colspan="8" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="statsConfirmOverlay" class="modal-overlay" role="dialog">
    <div class="modal">
      <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <p id="statsConfirmText">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°</p>
      <div class="mrow">
        <button id="statsConfirmCancel" class="btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="statsConfirmOk" class="btn-danger">‡∏•‡∏ö</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== PAGE: ADMIN ===================== -->
<div id="page-admin" class="page">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
      <div>
        <h1 class="h1">Admin</h1>
        <div class="muted" style="margin-top:6px;">‡πÄ‡∏î‡πÇ‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° login/logout ‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏à‡∏£‡∏¥‡∏á)</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="navigate('home')">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        <button class="btn" id="adminLoginBtn">Login</button>
        <button class="btn" id="adminLogoutBtn">Logout</button>
      </div>
    </div>
    <div id="adminGate" style="margin-top:16px;"></div>
    <div id="adminContent" style="display:none;">
      <div class="list">
        <div class="linkCard" onclick="navigate('admin_new')">
          <div style="font-weight:900;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</div>
          <div class="muted" style="margin-top:6px;">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏ß‡∏•‡∏≤/pdfUrl</div>
        </div>
      </div>
      <h2 class="h2" style="margin-top:16px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h2>
      <div class="card" style="padding:12px;margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <span class="muted">‡∏ß‡∏¥‡∏ä‡∏≤</span>
        <select id="adminSubjFilter" class="btn" style="padding:10px 12px;min-width:240px;"></select>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î</th>
              <th style="width:160px;">‡∏ß‡∏¥‡∏ä‡∏≤</th>
              <th style="width:120px;">‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th style="width:160px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th style="width:70px;">‡∏Ç‡πâ‡∏≠</th>
              <th style="width:150px;">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</th>
              <th>PDF URL</th>
              <th style="width:110px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
              <th style="width:70px;">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="adminTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===================== PAGE: ADMIN NEW ===================== -->
<div id="page-admin_new" class="page">
  <div class="container" style="max-width:900px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
      <div>
        <h1 class="h1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</h1>
        <div class="muted" style="margin-top:6px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÉ‡∏ô localStorage</div>
      </div>
      <button class="btn" onclick="navigate('admin')">‡∏Å‡∏•‡∏±‡∏ö Admin</button>
    </div>
    <div class="card" style="padding:16px;margin-top:16px;display:grid;gap:10px;">
      <label style="display:grid;gap:6px;">
        <span style="font-weight:900;">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</span>
        <input id="newTitle" style="padding:12px;border:1px solid var(--border);border-radius:12px;font-family:inherit;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2" />
      </label>
      <label style="display:grid;gap:6px;">
        <span style="font-weight:900;">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</span>
        <input id="newSubject" style="padding:12px;border:1px solid var(--border);border-radius:12px;font-family:inherit;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå" />
      </label>
      <div class="grid2">
        <label style="display:grid;gap:6px;">
          <span style="font-weight:900;">‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</span>
          <input id="newMinutes" type="number" min="1" value="45" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-family:inherit;" />
        </label>
        <label style="display:grid;gap:6px;">
          <span style="font-weight:900;">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</span>
          <select id="newPublished" style="padding:12px;border:1px solid var(--border);border-radius:12px;font-family:inherit;">
            <option value="true">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
            <option value="false">‡∏ã‡πà‡∏≠‡∏ô</option>
          </select>
        </label>
      </div>
      <label style="display:grid;gap:6px;">
        <span style="font-weight:900;">PDF URL</span>
        <input id="newPdfUrl" value="./pdfs/science_sample.pdf" style="padding:12px;border:1px solid var(--border);border-radius:12px;font-family:inherit;" />
        <span class="muted">‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà Google Drive /preview link</span>
      </label>
      <label style="display:grid;gap:6px;">
        <span style="font-weight:900;">‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
        <input id="newPdfFile" type="file" accept="application/pdf" style="padding:12px;border:1px dashed var(--border);border-radius:12px;background:#fff;" />
        <span class="muted">‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå (IndexedDB) ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
      </label>
      <div class="grid2" style="align-items:end;">
        <label style="display:grid;gap:6px;">
          <span style="font-weight:900;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠</span>
          <input id="newQCount" type="number" min="1" max="999" value="50" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-family:inherit;" />
          <span class="muted">‡πÅ‡∏Å‡πâ‡∏´‡∏ô‡πâ‡∏≤/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡πÄ‡∏â‡∏•‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏ô Editor</span>
        </label>
        <label style="display:flex;gap:10px;align-items:center;padding-bottom:28px;">
          <input id="newCreatePlaceholder" type="checkbox" checked />
          <span style="font-weight:900;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
        </label>
      </div>
      <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏≤‡∏Å Excel -->
      <div style="border:2px dashed var(--border);border-radius:12px;padding:16px;background:#f9fafb;display:grid;gap:8px;">
        <div style="font-weight:900;">üìä ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏≤‡∏Å Excel <span class="muted" style="font-size:12px;font-weight:400;">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></div>
        <div class="muted" style="font-size:12px;line-height:1.7;">
          ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <b>A = ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà</b> ¬∑ <b>B = ‡∏´‡∏ô‡πâ‡∏≤ PDF</b> ¬∑ <b>C = ‡πÄ‡∏â‡∏•‡∏¢</b> (‡∏Å/‡∏Ç/‡∏Ñ/‡∏á ‡∏´‡∏£‡∏∑‡∏≠ A/B/C/D)<br>
          ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô header ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <button type="button" class="btn" id="newDownloadTemplate" style="gap:6px;">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</button>
          <label class="btn" style="cursor:pointer;">
            üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel / CSV
            <input id="newExcelFile" type="file" accept=".xlsx,.xls,.csv" style="display:none;" />
          </label>
          <span id="newExcelStatus" class="muted" style="font-size:12px;"></span>
        </div>
        <div id="newExcelPreview" style="display:none;padding:8px 12px;background:#dcfce7;border-radius:8px;font-size:12px;color:#166534;font-weight:700;"></div>
      </div>

      <button class="btn btnPrimary" id="newCreateBtn" style="width:fit-content;">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
    </div>
  </div>
</div>

<!-- ===================== PAGE: ADMIN EDITOR ===================== -->
<div id="page-admin_editor" class="page">
  <div class="container" style="max-width:1400px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;">
      <div>
        <h1 class="h1" id="editorTitle">Editor</h1>
        <div class="muted" id="editorMeta" style="margin-top:6px;"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="navigate('admin')">‡∏Å‡∏•‡∏±‡∏ö Admin</button>
        <button class="btn" onclick="navigate('home')">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      </div>
    </div>
    <div style="margin-top:16px;">
      <div class="card">
        <div class="bar2">
          <div class="ctrls" style="gap:14px;flex-wrap:wrap;align-items:flex-end;">
            <div style="display:flex;flex-direction:column;gap:4px;">
              <div style="font-size:13px;font-weight:800;">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <input id="editorExamTitle" class="titleInput" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö" />
                <button class="btn" id="editorRenameBtn" type="button">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠</button>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;">
              <div style="font-size:13px;font-weight:800;">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</div>
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <input id="editorExamSubject" class="titleInput" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå" />
                <button class="btn" id="editorSubjectBtn" type="button">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤</button>
              </div>
              <div class="muted" style="font-size:12px;">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div>
            </div>
            <div class="muted" style="font-size:13px;max-width:520px;margin-bottom:6px;">Fast: Enter/Tab ‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Shift ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö)</div>
          </div>
          <div class="ctrls">
            <label style="display:flex;gap:8px;align-items:center;font-size:13px;">
              <input id="editorFast" type="checkbox" checked />
              ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏£‡πá‡∏ß
            </label>
            <button type="button" class="btn" id="editorDownloadTemplate">‚¨áÔ∏è Template Excel</button>
            <label class="btn" style="cursor:pointer;" title="‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: A=‡∏Ç‡πâ‡∏≠, B=‡∏´‡∏ô‡πâ‡∏≤PDF, C=‡πÄ‡∏â‡∏•‡∏¢(‡∏Å/‡∏Ç/‡∏Ñ/‡∏á)">
              üìä ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏¢ Excel
              <input id="editorExcelFile" type="file" accept=".xlsx,.xls,.csv" style="display:none;" />
            </label>
            <span id="editorExcelStatus" class="muted" style="font-size:12px;"></span>
            <button class="btn btnPrimary" id="editorSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </div>
        <div id="editorMsg" class="muted" style="padding:12px;display:none;"></div>
        <div class="tableBox">
          <table style="min-width:300px;">
            <thead>
              <tr>
                <th style="width:56px;">‡∏Ç‡πâ‡∏≠</th>
                <th style="width:100px;">‡∏´‡∏ô‡πâ‡∏≤ PDF</th>
                <th style="width:120px;">‡πÄ‡∏â‡∏•‡∏¢</th>
              </tr>
            </thead>
            <tbody id="editorTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== PDF VIEWER (PDF.js) =====================
// Single-page viewer ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å browser/OS
const PdfViewer = (() => {
  function create(containerId) {
    let pdfDoc = null;
    let currentUrl = null;
    let pageCanvases = []; // ‡πÄ‡∏Å‡πá‡∏ö canvas ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤

    const container = document.getElementById(containerId);
    container.style.cssText = 'width:100%;height:100%;background:#525659;display:flex;flex-direction:column;overflow:hidden;';

    // Scroll area ‚Äî render ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ scroll ‡πÑ‡∏î‡πâ
    const scrollArea = document.createElement('div');
    scrollArea.style.cssText = 'flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:8px 8px 24px;display:flex;flex-direction:column;gap:8px;align-items:center;';

    const statusDiv = document.createElement('div');
    statusDiv.style.cssText = 'color:#ccc;font-size:13px;padding:40px 20px;text-align:center;';
    statusDiv.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î PDF...';
    scrollArea.appendChild(statusDiv);
    container.appendChild(scrollArea);

    async function renderAllPages() {
      if (!pdfDoc) return;
      scrollArea.innerHTML = '';
      pageCanvases = [];

      // ‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ container ‡∏à‡∏∞‡∏°‡∏µ width ‡∏à‡∏£‡∏¥‡∏á‡πÜ (max 20 ‡∏£‡∏≠‡∏ö = ~333ms)
      let waitCount = 0;
      while ((scrollArea.clientWidth || container.clientWidth) < 10 && waitCount < 20) {
        await new Promise(r => requestAnimationFrame(r));
        waitCount++;
      }

      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      const containerWidth = Math.max(scrollArea.clientWidth || container.clientWidth || 0, 10) - 16;
      if (containerWidth < 10) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ width ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ element ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà ‚Äî retry ‡∏´‡∏•‡∏±‡∏á 300ms
        await new Promise(r => setTimeout(r, 300));
      }

      for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        const wrapper = document.createElement('div');
        wrapper.id = `${containerId}-page-${pageNum}`;
        wrapper.style.cssText = 'width:100%;display:flex;flex-direction:column;align-items:center;gap:4px;';

        const label = document.createElement('div');
        label.style.cssText = 'color:#aaa;font-size:11px;padding:4px 0 2px;';
        label.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${pageNum} / ${pdfDoc.numPages}`;

        const canvas = document.createElement('canvas');
        canvas.style.cssText = 'max-width:100%;border-radius:4px;box-shadow:0 2px 12px rgba(0,0,0,0.5);background:#fff;display:block;';

        wrapper.appendChild(label);
        wrapper.appendChild(canvas);
        scrollArea.appendChild(wrapper);
        pageCanvases[pageNum] = canvas;

        try {
          const page = await pdfDoc.getPage(pageNum);
          const viewport = page.getViewport({ scale: 1 });
          // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ width ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
          const w = scrollArea.clientWidth > 16 ? scrollArea.clientWidth - 16 : containerWidth;
          const scale = (w / viewport.width) * dpr;
          const scaledVp = page.getViewport({ scale });
          canvas.width = scaledVp.width;
          canvas.height = scaledVp.height;
          canvas.style.width = Math.round(scaledVp.width / dpr) + 'px';
          canvas.style.height = Math.round(scaledVp.height / dpr) + 'px';
          const ctx = canvas.getContext('2d');
          // PDF.js render ‡∏ó‡∏µ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡πÉ‡∏ä‡πâ await ‡πÄ‡∏û‡∏∑‡πà‡∏≠ sequential
          await page.render({ canvasContext: ctx, viewport: scaledVp }).promise;
          // cleanup page object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î memory
          page.cleanup();
        } catch(e) {
          console.warn(`Page ${pageNum} render error:`, e);
          canvas.style.display = 'none';
          const err = document.createElement('div');
          err.style.cssText = 'color:#f88;font-size:12px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;margin:4px;';
          err.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${pageNum}: ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${e?.message||e})`;
          wrapper.appendChild(err);
        }
      }
    }

    // Scroll ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà re-render
    function scrollToPage(pageNum) {
      const el = document.getElementById(`${containerId}-page-${pageNum}`);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ‡∏î‡∏∂‡∏á Google Drive File ID ‡∏à‡∏≤‡∏Å URL ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ
    function getGDriveFileId(url) {
      if (!url) return null;
      const m1 = url.match(/drive\.google\.com\/file\/d\/([^/?#]+)/);
      if (m1) return m1[1];
      const m2 = url.match(/[?&]id=([^&]+)/);
      if (m2 && url.includes('drive.google.com')) return m2[1];
      return null;
    }

    // ‡πÅ‡∏™‡∏î‡∏á Google Drive PDF ‡∏ú‡πà‡∏≤‡∏ô iframe embed (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS ‡πÑ‡∏î‡πâ)
    function loadGDriveEmbed(fileId) {
      // reset container ‡πÄ‡∏õ‡πá‡∏ô block ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÉ‡∏´‡πâ iframe ‡πÉ‡∏ä‡πâ height ‡∏à‡∏≤‡∏Å CSS ‡∏Ç‡∏≠‡∏á #takePdfViewer
      container.style.cssText = 'width:100%;height:100%;background:#525659;display:block;overflow:hidden;';
      scrollArea.style.cssText = 'width:100%;height:100%;padding:0;overflow:hidden;display:block;';
      scrollArea.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
      iframe.allow = 'autoplay';
      iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
      scrollArea.appendChild(iframe);
    }

    async function loadUrl(url, page) {
      page = page || 1;
      scrollArea.innerHTML = '';
      scrollArea.appendChild(statusDiv);
      statusDiv.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î PDF...';
      pageCanvases = [];
      currentUrl = url;
      pdfDoc = null;

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Google Drive URL ‚Äî ‡πÉ‡∏ä‡πâ iframe embed ‡πÅ‡∏ó‡∏ô PDF.js (‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î CORS)
      const gdriveId = getGDriveFileId(url);
      if (gdriveId) {
        loadGDriveEmbed(gdriveId);
        return;
      }

      // URL ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚Äî ‡πÉ‡∏ä‡πâ PDF.js render
      try {
        if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä');

        // ‡πÅ‡∏õ‡∏•‡∏á relative path ‡πÄ‡∏õ‡πá‡∏ô absolute
        let absUrl = url;
        if (!url.startsWith('blob:') && !url.startsWith('http') && !url.startsWith('data:')) {
          absUrl = new URL(url, window.location.href).href;
        }

        statusDiv.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á render PDF...';
        pdfDoc = await pdfjsLib.getDocument({
          url: absUrl,
          cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
          cMapPacked: true,
        }).promise;
        await renderAllPages();
        setTimeout(() => scrollToPage(page), 150);
      } catch(e) {
        console.error('loadUrl error', e);
        const msg = e?.message || String(e);
        let hint = '';
        if (msg.includes('Invalid PDF') || msg.includes('structure')) {
          hint = '<br><small style="color:#faa;">üí° ‡∏•‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏´‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin</small>';
        } else if (msg.includes('404') || msg.includes('403')) {
          hint = '<br><small style="color:#faa;">üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ URL ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞ PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</small>';
        }
        scrollArea.innerHTML = `<div style="color:#f88;padding:20px;font-size:13px;line-height:1.8;">‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><code style="font-size:11px;opacity:.7;">${msg}</code>${hint}</div>`;
      }
    }

    // setPage ‡πÅ‡∏Ñ‡πà scroll ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á re-render
    async function setPage(page) {
      if (!pdfDoc) return;
      scrollToPage(page);
    }

    return { loadUrl, setPage };
  }

  return { create };
})();

// ===================== STORE =====================
const Store = {
  lastError:null,
  key:"quizSciDemoStoreV1",
  migrate(s){
    if(!s||typeof s!=='object') return s;
    if(!Array.isArray(s.exams)) s.exams=[];
    if(!s.adminExamSortBy) s.adminExamSortBy='order';
    if(!s.adminExamSortDir) s.adminExamSortDir='asc';
    let changed=false, maxOrder=0;
    s.exams.forEach((e,idx)=>{
      if(!e) return;
      if(!e.subject||typeof e.subject!=='string'){e.subject='‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';changed=true;}
      if(typeof e.uploadedAt!=='number'){e.uploadedAt=Date.now()-(s.exams.length-idx)*1000;changed=true;}
      if(typeof e.order!=='number'){e.order=idx+1;changed=true;}
      if(e.order>maxOrder) maxOrder=e.order;
    });
    const seen=new Set();
    s.exams.forEach((e)=>{
      if(!e) return;
      if(seen.has(e.order)){maxOrder+=1;e.order=maxOrder;changed=true;}
      seen.add(e.order);
    });
    if(changed) this.save(s);
    return s;
  },
  load(){try{return JSON.parse(localStorage.getItem(this.key)||"{}");}catch{return {};}},
  save(data){
    try{this.lastError=null;localStorage.setItem(this.key,JSON.stringify(data));return true;}
    catch(e){this.lastError=String(e&&e.message?e.message:e);console.warn('Store.save failed',e);return false;}
  },
  init(){
    const s=this.load();
    if(!s.exams){
      const examId="exam1";
      s.exams=[{id:examId,subject:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå",title:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå A Level 5 ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1 (Demo)",durationSeconds:2700,published:true,pdfUrl:"./pdfs/science_sample.pdf",questionCount:50,uploadedAt:Date.now(),order:1}];
      s.questions={};
      const pageFor=(n)=>{
        if(n<=4)return 1;if(n<=9)return 2;if(n<=14)return 3;if(n<=19)return 4;
        if(n<=24)return 5;if(n<=27)return 6;if(n<=32)return 7;if(n<=36)return 8;
        if(n<=40)return 9;if(n<=46)return 10;return 11;
      };
      s.questions[examId]=Array.from({length:50}).map((_,i)=>({id:"q"+(i+1),number:i+1,no:i+1,page:pageFor(i+1),choices:{A:"",B:"",C:"",D:""},correct:"A"}));
      s.attempts=[];
      s.adminLoggedIn=false;
      this.save(s);
    }
    // Ensure no field is missing from the seed data
    (s.questions||{});
    if(!s.questions) s.questions={};
    return this.migrate(s);
  }
};

const PdfDB=(()=>{
  const DB_NAME="quiz_pdf_db",STORE_NAME="pdfs",VERSION=1;
  function open(){
    return new Promise((resolve,reject)=>{
      const req=indexedDB.open(DB_NAME,VERSION);
      req.onupgradeneeded=()=>{const db=req.result;if(!db.objectStoreNames.contains(STORE_NAME))db.createObjectStore(STORE_NAME);};
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });
  }
  async function put(key,blob){const db=await open();return new Promise((resolve,reject)=>{const tx=db.transaction(STORE_NAME,"readwrite");tx.objectStore(STORE_NAME).put(blob,key);tx.oncomplete=()=>resolve(true);tx.onerror=()=>reject(tx.error);});}
  async function get(key){const db=await open();return new Promise((resolve,reject)=>{const tx=db.transaction(STORE_NAME,"readonly");const req=tx.objectStore(STORE_NAME).get(key);req.onsuccess=()=>resolve(req.result||null);req.onerror=()=>reject(req.error);});}
  async function del(key){const db=await open();return new Promise((resolve,reject)=>{const tx=db.transaction(STORE_NAME,"readwrite");tx.objectStore(STORE_NAME).delete(key);tx.oncomplete=()=>resolve(true);tx.onerror=()=>reject(tx.error);});}
  const blobUrlCache={};
  async function getPdfBlobUrl(key){
    if(blobUrlCache[key]) return blobUrlCache[key];
    const blob=await get(key);
    if(!blob) return null;
    blobUrlCache[key]=URL.createObjectURL(blob);
    return blobUrlCache[key];
  }
  return{put,get,del,getPdfBlobUrl};
})();

function toast(msg){
  const el=document.getElementById("toast");
  if(!el) return alert(msg);
  el.textContent=msg;el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"),1600);
}
function fmtTime(sec){
  sec=Math.max(0,sec|0);
  return String(Math.floor(sec/60)).padStart(2,"0")+":"+String(sec%60).padStart(2,"0");
}
function esc(v){return String(v??"").replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
function escHtml(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');}

// ===================== ROUTER =====================
let _currentPage='home';
let _pageParams={};

function navigate(page, params={}){
  // hide take page cleanup
  if(_currentPage==='take') cleanupTake();

  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el=document.getElementById('page-'+page);
  if(!el){console.warn('page not found:',page);return;}
  el.classList.add('active');
  _currentPage=page;
  _pageParams=params;

  // init page
  if(page==='home'){}
  else if(page==='exams') initExams();
  else if(page==='exam') initExamDetail(params.id);
  else if(page==='take') initTake(params.id);
  else if(page==='review') initReview(params.attemptId);
  else if(page==='stats') initStats();
  else if(page==='admin') initAdmin();
  else if(page==='admin_new') initAdminNew();
  else if(page==='admin_editor') initEditor(params.id);

  window.scrollTo(0,0);
}

// ===================== EXAMS PAGE =====================
function initExams(){
  const s=Store.load();
  const published=(s.exams||[]).filter(e=>e.published);
  const subjFilterEl=document.getElementById('examsSubjFilter');
  let subjectFilter='';

  const subjects=Array.from(new Set(published.map(e=>(e.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')))).sort((a,b)=>a.localeCompare(b,'th'));
  subjFilterEl.innerHTML=`<option value="">‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>${subjects.map(sub=>`<option value="${esc(sub)}">${esc(sub)}</option>`).join('')}`;

  function renderExams(){
    const s2=Store.load();
    const allAttempts=s2.attempts||[];
    const exams=subjectFilter?published.filter(e=>(e.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')===subjectFilter):published;
    const list=document.getElementById('examsList');
    list.className='examGrid';
    list.innerHTML='';
    exams.forEach(e=>{
      // ‡∏´‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const myAttempts=allAttempts.filter(a=>a.examId===e.id);
      const last=myAttempts[0];
      const bestScore=myAttempts.length?Math.max(...myAttempts.map(a=>a.score)):null;
      const card=document.createElement('div');
      card.className='examCard';
      const scoreHtml=last
        ?`<div class="score-badge">üèÜ ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î <b>${bestScore}/${e.questionCount}</b> &nbsp;‚Ä¢&nbsp; ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <b>${last.score}/${last.total}</b> (${Math.round(last.score/last.total*100)}%) &nbsp;‚Ä¢&nbsp; ‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß ${myAttempts.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>`
        :`<div class="score-badge" style="color:var(--muted);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥</div>`;
      card.innerHTML=`
        <span class="subj">${esc(e.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')}</span>
        <div class="title">${esc(e.title)}</div>
        <div class="meta">
          <span>üìù ${e.questionCount} ‡∏Ç‡πâ‡∏≠</span>
          <span>‚è± ${Math.round(e.durationSeconds/60)} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
        </div>
        ${scoreHtml}
      `;
      card.onclick=()=>navigate('exam',{id:e.id});
      list.appendChild(card);
    });
    if(!list.children.length) list.innerHTML=`<div class="muted" style="padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</div>`;
  }

  subjFilterEl.onchange=(e)=>{subjectFilter=e.target.value;renderExams();};
  renderExams();
}

// ===================== EXAM DETAIL PAGE =====================
function initExamDetail(id){
  const LAST_TAKER_KEY='nanont:lastTakerName';
  const s=Store.load();
  const exam=s.exams.find(e=>e.id===id);
  const wrap=document.getElementById('examDetailWrap');
  if(!exam){wrap.innerHTML=`<h1 class="h1">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h1>`;return;}
  wrap.innerHTML=`
    <h1 class="h1">${esc(exam.title)}</h1>
    <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <span class="badge ok">${esc(exam.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')}</span>
      <span class="muted" style="font-size:14px;">üìù ${exam.questionCount} ‡∏Ç‡πâ‡∏≠</span>
      <span class="muted" style="font-size:14px;">‚è± ${Math.round(exam.durationSeconds/60)} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
    </div>
    <div class="hr"></div>
    <div class="card" style="padding:20px;display:grid;gap:16px;max-width:480px;">
      <label style="display:grid;gap:8px;">
        <span style="font-weight:900;font-size:15px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö <span class="muted">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></span>
        <input id="detailTakerName" class="btn" style="text-align:left;padding:14px;width:100%;font-size:15px;border-radius:14px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏ô‡∏ó‡πå / Smith" />
      </label>
      <button class="btn btnPrimary" id="examStartBtn" style="padding:16px;font-size:16px;border-radius:14px;">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
    </div>
  `;
  // restore last taker name
  const takerEl = document.getElementById('detailTakerName');
  takerEl.value = localStorage.getItem(LAST_TAKER_KEY) || '';

  document.getElementById('examStartBtn').onclick=()=>{
    const name = takerEl.value.trim();
    if(name) localStorage.setItem(LAST_TAKER_KEY, name);
    navigate('take', {id:exam.id, takerName:name});
  };
  // ‡∏Å‡∏î Enter ‡∏Å‡πá‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
  takerEl.addEventListener('keydown', (e)=>{
    if(e.key==='Enter') document.getElementById('examStartBtn').click();
  });
}

// ===================== TAKE PAGE =====================
let _takeInterval=null;
let _takeState=null;

function cleanupTake(){
  if(_takeInterval){clearInterval(_takeInterval);_takeInterval=null;}
  _takeState=null;
}

function initTake(id){
  cleanupTake();
  const s=Store.load();
  const exam=s.exams.find(e=>e.id===id);
  if(!exam){navigate('exams');return;}

  // normalize questions: ensure .no field
  const qsList=(s.questions[id]||[]).map(q=>({...q, no: q.no??q.number??0}));
  const total=qsList.length;
  const attemptId='att_'+Math.random().toString(16).slice(2);
  const LAST_TAKER_KEY='nanont:lastTakerName';
  // ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å params (‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ detail ‡πÅ‡∏•‡πâ‡∏ß)
  const _takerName = (_pageParams.takerName||localStorage.getItem(LAST_TAKER_KEY)||'').trim();
  if(_takerName) localStorage.setItem(LAST_TAKER_KEY, _takerName);

  _takeState={s,exam,qsList,total,attemptId,
    currentIndex:0,answers:{},unsure:{},
    started:false,startedAt:null,createdAt:Date.now(),
    takerName:_takerName
  };
  const st=_takeState;

  document.getElementById('takeExamTitle').textContent=exam.title;
  document.getElementById('takeQTotal').textContent=total;

  // PDF.js viewer for take page
  // ‡∏•‡πâ‡∏≤‡∏á viewer ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô cache ‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
  document.getElementById('takePdfViewer').innerHTML = '';
  const _takePdfViewer = PdfViewer.create('takePdfViewer');
  let _takePdfLoaded = false; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

  async function getPdfBlobUrl(pdfUrl){
    if(pdfUrl.startsWith('localpdf:')){
      const key=pdfUrl.slice('localpdf:'.length);
      const blob=await PdfDB.get(key);
      if(!blob) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ');
      return URL.createObjectURL(blob);
    }
    return pdfUrl;
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Google Drive URL ‡πÑ‡∏´‡∏°
  const _isGDrive = !!(exam.pdfUrl||'').match(/drive\.google\.com/);

  // ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡πÑ‡∏°‡πà auto-scroll ‡∏ï‡∏≠‡∏ô‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏≠‡∏á)
  async function loadPdfOnce(){
    if(_takePdfLoaded) return;
    _takePdfLoaded = true;
    try{
      let pdfUrl = exam.pdfUrl||'';
      if(pdfUrl.startsWith('./') || pdfUrl.startsWith('../')){
        pdfUrl = new URL(pdfUrl, window.location.href).href;
      }
      const url = pdfUrl.startsWith('localpdf:') ? await getPdfBlobUrl(pdfUrl) : pdfUrl;
      await _takePdfViewer.loadUrl(url, 1);
    } catch(err){ toast(err?.message||String(err)); }
  }

  // setPdfPage ‡∏ï‡∏≠‡∏ô take = ‡πÅ‡∏Ñ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÑ‡∏°‡πà scroll
  async function setPdfPage(page){
    await loadPdfOnce();
  }

  if(qsList[0]) setPdfPage(qsList[0].page||1);

  // build num buttons
  const numsEl=document.getElementById('takeNums');
  numsEl.innerHTML='';
  qsList.forEach((q,idx)=>{
    const b=document.createElement('button');
    b.className='btn numBtn';
    b.textContent=q.number||q.no;
    b.addEventListener('click',()=>{st.currentIndex=idx;render();});
    numsEl.appendChild(b);
  });

  function setNumStyles(){
    [...numsEl.children].forEach((b,idx)=>{
      const q=qsList[idx];
      const done=!!st.answers[q.id];
      const markUnsure=!!st.unsure[q.id];
      const active=idx===st.currentIndex;
      b.style.fontWeight=active?900:800;
      b.style.borderColor=active?'var(--black)':'var(--border)';
      b.style.background='#fff';b.style.color='#111';
      if(done){b.style.background='var(--black)';b.style.borderColor='var(--black)';b.style.color='#fff';}
      if(markUnsure){b.style.background='var(--warn)';b.style.borderColor='var(--warn)';b.style.color='#111';}
      if(active) b.style.boxShadow='0 0 0 2px rgba(17,24,39,.25)';
      else b.style.boxShadow='none';
    });
  }

  const labelMap={A:'‡∏Å',B:'‡∏Ç',C:'‡∏Ñ',D:'‡∏á'};

  function render(){
    const q=qsList[st.currentIndex];
    document.getElementById('takeQNo').textContent=q.number||q.no;
    document.getElementById('takePdfPage').textContent=_isGDrive ? 'üìÑ Google Drive (scroll ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏¥‡πâ‡∏ß)' : 'PDF ‡∏´‡∏ô‡πâ‡∏≤ '+(q.page||1);
    const ub=document.getElementById('takeUnsureBtn');
    if(ub){
      ub.disabled=!st.started;
      const u=!!st.unsure[q.id];
      ub.textContent=u?'‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‚úì':'‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à';
      ub.className=u?'btn btnPrimary':'btn';
    }
    setPdfPage(q.page||1);
    const wrap=document.getElementById('takeChoices');
    wrap.innerHTML='';
    ['A','B','C','D'].forEach(lab=>{
      const div=document.createElement('label');
      div.className='choice'+((st.answers[q.id]===lab)?' active':'');
      if(!st.started){div.style.opacity='0.6';div.style.pointerEvents='none';}
      div.innerHTML=`<span style="font-weight:900;font-size:15px;">${labelMap[lab]}</span>`;
      div.addEventListener('click',()=>{if(!st.started) return;st.answers[q.id]=lab;render();});
      wrap.appendChild(div);
    });
    document.getElementById('takePrevBtn').disabled=st.currentIndex===0;
    document.getElementById('takeNextBtn').disabled=st.currentIndex===total-1;
    setNumStyles();
  }

  document.getElementById('takePrevBtn').onclick=()=>{st.currentIndex=Math.max(0,st.currentIndex-1);render();};
  document.getElementById('takeNextBtn').onclick=()=>{st.currentIndex=Math.min(total-1,st.currentIndex+1);render();};
  document.getElementById('takeUnsureBtn').onclick=()=>{
    if(!st.started){toast('‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô');return;}
    const q=qsList[st.currentIndex];
    st.unsure[q.id]=!st.unsure[q.id];
    render();
  };

  function submit(){
    if(!st.started){toast('‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô');return;}
    if(_takeInterval){clearInterval(_takeInterval);_takeInterval=null;}
    let score=0;
    qsList.forEach(q=>{if(st.answers[q.id]&&st.answers[q.id]===q.correct) score++;});
    const perQuestion=qsList.map(q=>{
      const chosen=st.answers[q.id]||null;
      const correct=q.correct||null;
      return{qid:q.id,no:q.no||q.number,page:q.page,chosen,correct,isCorrect:chosen&&correct?(chosen===correct):false,unsure:!!st.unsure[q.id]};
    });
    const usedSeconds=st.startedAt?Math.min(Math.floor((Date.now()-st.startedAt)/1000),exam.durationSeconds):0;
    const takerName=st.takerName||localStorage.getItem(LAST_TAKER_KEY)||'';
    const savedS=Store.load();
    savedS.attempts.unshift({id:st.attemptId,examId:exam.id,examTitle:exam.title,examSubject:exam.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',takerName,startedAt:new Date(st.startedAt??st.createdAt).toISOString(),submittedAt:new Date().toISOString(),usedSeconds,score,total,answers:{...st.answers},perQuestion});
    const ok=Store.save(savedS);
    if(!ok) alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢: ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏ö‡∏ô iPad/iOS ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö localStorage\n\n‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå https ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
    navigate('review',{attemptId:st.attemptId});
  }

  const submitBtn=document.getElementById('takeSubmitBtn');
  // remove old listeners by replacing
  const newSubmitBtn=submitBtn.cloneNode(true);
  submitBtn.parentNode.replaceChild(newSubmitBtn,submitBtn);
  newSubmitBtn.addEventListener('click',()=>{if(confirm('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ? (‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏â‡∏•‡∏¢/‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô)')) submit();});

  const t1=document.getElementById('takeTimer'),t2=document.getElementById('takeTimer2');
  function setTimerDisplay(remaining){
    const fmt=fmtTime(remaining);
    t1.textContent=fmt; t2.textContent=fmt;
    const urgent = remaining <= 600; // 10 ‡∏ô‡∏≤‡∏ó‡∏µ
    const color = urgent ? '#dc2626' : '';
    const weight = urgent ? '900' : '';
    [t1,t2].forEach(t=>{t.style.color=color;t.style.fontWeight=weight;});
    // ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏ô‡∏≤‡∏ó‡∏µ
    if(remaining <= 60){
      t1.style.animation='pulse 1s infinite';
      t2.style.animation='pulse 1s infinite';
    }
  }
  setTimerDisplay(exam.durationSeconds);

  function doStart(){
    if(st.started) return;
    st.started=true;
    st.startedAt=Date.now();
    newSubmitBtn.disabled=false; // ‡πÉ‡∏ä‡πâ newSubmitBtn ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà getElementById ‡∏ó‡∏µ‡πà‡∏´‡∏≤ element ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà replace ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
    render();
    _takeInterval=setInterval(()=>{
      const elapsed=Math.floor((Date.now()-st.startedAt)/1000);
      const remaining=Math.max(0,exam.durationSeconds-elapsed);
      setTimerDisplay(remaining);
      if(remaining===0){clearInterval(_takeInterval);_takeInterval=null;submit();}
    },250);
  }

  // Auto-start ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ take (‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
  setTimeout(doStart, 300);
  document.getElementById('takeExitBtn').onclick=()=>{if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n\n‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á')){cleanupTake();navigate('exams');}};

  render();
}

// ===================== REVIEW PAGE =====================
function initReview(attemptId){
  const s=Store.load();
  const att=(s.attempts||[]).find(a=>a.id===attemptId);
  if(!attemptId||!att){
    document.getElementById('reviewTitle').textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö';
    document.getElementById('reviewSub').textContent='‡∏•‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
    return;
  }
  const exam=(s.exams||[]).find(e=>e.id===att.examId);
  const _reviewIsGDrive = !!(exam && (exam.pdfUrl||'').match(/drive\.google\.com/));

  // *** FIX: use correct key s.questions (not s.questionsByExam) ***
  const qMap=s.questions||s.questionsByExam||{};
  let qs=qMap[att.examId]||[];

  // Fallback: rebuild from perQuestion saved in attempt
  if(!qs.length&&Array.isArray(att.perQuestion)&&att.perQuestion.length){
    qs=att.perQuestion.map(p=>({id:p.qid||String(p.no),no:p.no,page:p.page||1,correct:p.correct||null,choices:{}}));
  }

  // Normalize: seed data may use .number instead of .no
  qs.forEach(q=>{if(q.no==null&&q.number!=null) q.no=q.number;});

  const taker=(att.takerName||'').trim()||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const subj=(exam&&exam.subject)?exam.subject:(att.examSubject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
  document.getElementById('reviewTitle').textContent=`‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô: ${att.examTitle||'‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö'}`;
  document.getElementById('reviewSub').textContent=`‡∏ß‡∏¥‡∏ä‡∏≤: ${subj} ‚Ä¢ ‡∏ú‡∏π‡πâ‡∏ó‡∏≥: ${taker}`;
  document.getElementById('reviewScore').textContent=`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${att.score}/${att.total}`;

  function fmtDate(iso){try{return new Date(iso).toLocaleString('th-TH');}catch(e){return iso||'';}}
  function fmtDur(sec){sec=Math.max(0,Number(sec||0));const m=Math.floor(sec/60),ss=sec%60;return String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0');}

  document.getElementById('reviewMeta').textContent=`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: ${fmtDate(att.submittedAt)} ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ${fmtDur(att.usedSeconds)}`;
  document.getElementById('reviewPdfLabel').textContent=exam?esc(exam.title||'PDF'):'PDF';

  const answers=att.answers||{};
  const total=Number(att.total||qs.length||0);
  const correctCount=Number.isFinite(Number(att.score))?Number(att.score):0;

  let wrongNos=[];
  if(Array.isArray(att.perQuestion)&&att.perQuestion.length){
    wrongNos=att.perQuestion.filter(p=>!p.isCorrect).map(p=>Number(p.no)||0).filter(n=>n>0);
  } else {
    qs.forEach((q,idx)=>{
      const chosen=(answers[q.id]??answers[String(q.id)]??null);
      const cc=chosen==null?null:String(chosen).trim();
      const qc=q.correct==null?null:String(q.correct).trim();
      if(!(cc!=null&&qc!=null&&cc===qc)) wrongNos.push(Number(q.no)||idx+1);
    });
  }

  const wrongUnique=Array.from(new Set(wrongNos)).sort((a,b)=>a-b);
  const wrongCount=Math.max(0,total-correctCount);
  const pct=total?Math.round((correctCount/total)*100):0;
  document.getElementById('reviewSummaryLine').textContent=`‡∏ñ‡∏π‡∏Å ${correctCount}/${total} (${pct}%) ‚Ä¢ ‡∏ú‡∏¥‡∏î ${wrongCount} ‡∏Ç‡πâ‡∏≠`;

  const wrongListText=document.getElementById('reviewWrongListText');
  if(wrongListText){
    const listStr=wrongUnique.length?wrongUnique.join(', '):'-';
    wrongListText.innerHTML=`<span class="label">‡∏ú‡∏¥‡∏î‡∏Ç‡πâ‡∏≠:</span> <span class="list">${listStr}</span>`;
  }

  const wrongSet=new Set(wrongUnique);
  function isCorrectQ(q){
    const no=Number(q.no)||0;
    if(no&&wrongSet.has(no)) return false;
    if(Array.isArray(att.perQuestion)&&att.perQuestion.length){
      const p=att.perQuestion.find(x=>Number(x.no)===no);
      if(p) return !!p.isCorrect;
    }
    const chosen=(answers[q.id]??answers[String(q.id)]??null);
    const cc=chosen==null?null:String(chosen).trim();
    const qc=q.correct==null?null:String(q.correct).trim();
    return(cc!=null&&qc!=null&&cc===qc);
  }

  // Nav chips
  const nav=document.getElementById('reviewNavChips');
  nav.innerHTML='';
  qs.forEach(q=>{
    const ok=isCorrectQ(q);
    const b=document.createElement('button');
    b.className='chip '+(ok?'good':'bad');
    b.textContent=q.no;
    b.onclick=()=>{
      if(!_reviewIsGDrive) setPdfPage(q.page||1);
    };
    nav.appendChild(b);
  });

  // Question list
  const list=document.getElementById('reviewQList');
  list.innerHTML='';
  qs.forEach((q)=>{
    const chosen=(answers[q.id]??answers[String(q.id)]??null);
    const correct=(q.correct==null)?null:String(q.correct).trim();
    const isCorrect=isCorrectQ(q);
    const wrap=document.createElement('div');
    wrap.className='qItem';wrap.id=`rq-${q.no}`;
    wrap.innerHTML=`
      <div class="qHead">
        <div style="font-weight:800;">‡∏Ç‡πâ‡∏≠ ${q.no} <span class="muted">(‡∏´‡∏ô‡πâ‡∏≤ ${q.page||1})</span></div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="qBadge ${isCorrect?'good':'bad'}">${isCorrect?'‡∏ñ‡∏π‡∏Å':(chosen?'‡∏ú‡∏¥‡∏î':'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö')}</span>
          ${(!_reviewIsGDrive && q.page) ? '<button class="btn" data-page="'+q.page+'">‡∏´‡∏ô‡πâ‡∏≤ '+q.page+'</button>' : ''}
        </div>
      </div>
      <div class="muted" style="margin-top:6px;">‡πÄ‡∏â‡∏•‡∏¢: <b>${correct||'-'}</b> ‚Ä¢ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <b>${chosen==null?'-':String(chosen).trim()}</b></div>
      <div class="opts"></div>
    `;
    const pageBtn=wrap.querySelector('button[data-page]'); if(pageBtn) pageBtn.onclick=(e)=>{e.stopPropagation();setPdfPage(Number(pageBtn.dataset.page)||1);};
    const opts=wrap.querySelector('.opts');
    ['‡∏Å','‡∏Ç','‡∏Ñ','‡∏á'].forEach(key=>{
      const text=(q.choices&&q.choices[key])?q.choices[key]:((q.options&&q.options[key])?q.options[key]:'');
      const div=document.createElement('div');
      const isChosen=chosen===key;
      const isCorr=correct===key;
      let cls='opt';
      if(isCorr) cls+=' correct';
      if(isChosen){cls+=' chosen '+(isCorr?'good':'bad');}
      div.className=cls;
      div.innerHTML=`<div class="optKey">${key}</div><div style="flex:1;min-width:0;">${text?escHtml(text):'<span class="muted">(‡∏ß‡πà‡∏≤‡∏á)</span>'}</div>${isCorr?'<div class="tag">‡πÄ‡∏â‡∏•‡∏¢</div>':(isChosen?'<div class="tag">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>':'')}`;
      opts.appendChild(div);
    });
    list.appendChild(wrap);
  });

  // PDF viewer for review page ‚Äî ‡πÉ‡∏ä‡πâ iframe ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô take page
  const reviewViewerEl = document.getElementById('reviewPdfViewer');
  reviewViewerEl.innerHTML = '';
  let _reviewCurrentPage = 1;
  let _reviewPdfLoaded = false;

  // ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  async function loadReviewPdf() {
    if (_reviewPdfLoaded) return;
    _reviewPdfLoaded = true;
    try {
      if (!exam || !exam.pdfUrl) return;
      const pdfUrl = exam.pdfUrl;

      if (_reviewIsGDrive) {
        // Google Drive ‚Üí iframe embed ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô take page
        const m = pdfUrl.match(/drive\.google\.com\/file\/d\/([^/?#]+)/);
        const id2 = m ? m[1] : (pdfUrl.match(/[?&]id=([^&]+)/) || [])[1];
        if (id2) {
          reviewViewerEl.style.cssText = 'width:100%;height:70vh;min-height:400px;position:relative;';
          const iframe = document.createElement('iframe');
          iframe.src = `https://drive.google.com/file/d/${id2}/preview`;
          iframe.allow = 'autoplay';
          iframe.style.cssText = 'width:100%;height:100%;border:none;display:block;';
          reviewViewerEl.appendChild(iframe);
          return;
        }
      }

      // upload file / same-origin ‚Üí PDF.js
      const _reviewPdfViewer = PdfViewer.create('reviewPdfViewer');
      let url = pdfUrl;
      if (url.startsWith('localpdf:')) {
        const key = url.slice('localpdf:'.length);
        const blob = await PdfDB.get(key);
        if (!blob) { toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF'); return; }
        url = URL.createObjectURL(blob);
      } else if (url.startsWith('./') || url.startsWith('../')) {
        url = new URL(url, window.location.href).href;
      }
      await _reviewPdfViewer.loadUrl(url, _reviewCurrentPage);

      // ‡πÄ‡∏Å‡πá‡∏ö reference ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ setPdfPage ‡πÉ‡∏ä‡πâ
      reviewViewerEl._pdfViewer = _reviewPdfViewer;
    } catch(err) { toast(err?.message || String(err)); }
  }

  async function setPdfPage(p) {
    if (_reviewIsGDrive) return; // gdrive ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
    _reviewCurrentPage = Math.max(1, Number(p || 1));
    if (!_reviewPdfLoaded) {
      await loadReviewPdf(); // ‡πÇ‡∏´‡∏•‡∏î + ‡∏à‡∏∞ scroll ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ _reviewCurrentPage
    } else if (reviewViewerEl._pdfViewer) {
      reviewViewerEl._pdfViewer.setPage(_reviewCurrentPage); // scroll PDF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    }
  }
  window.__reviewSetPdfPage = setPdfPage;

  document.getElementById('reviewScrollTop').onclick = () => window.scrollTo({top:0, behavior:'smooth'});

  // ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠
  loadReviewPdf();
  const firstPage = (qs[0] && qs[0].page) ? qs[0].page : 1;
  _reviewCurrentPage = firstPage;
}

// ===================== STATS PAGE =====================
function initStats(){
  let pendingDeleteAttemptId=null;
  let currentExamFilter='all';
  let currentSubjectFilter='all';
  const filterEl=document.getElementById('statsFilterExam');
  const subjectEl=document.getElementById('statsFilterSubject');

  function getExamSubjectById(s,examId){
    if(!examId) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const ex=(s.exams||[]).find(e=>e.id===examId);
    if(ex?.subject) return ex.subject;
    const att=(s.attempts||[]).find(a=>a.examId===examId);
    return att?.examSubject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  }
  function getExamTitleById(s,examId){
    if(!examId) return '‚Äî';
    return(s.exams||[]).find(e=>e.id===examId)?.title||(s.attempts||[]).find(a=>a.examId===examId)?.examTitle||'‚Äî';
  }
  function formatDuration(sec){
    sec=Math.max(0,Math.floor(sec||0));
    return String(Math.floor(sec/60)).padStart(2,'0')+':'+String(sec%60).padStart(2,'0');
  }

  function rebuildFilterOptions(s){
    if(!filterEl) return;
    const examIds=new Set();
    (s.exams||[]).forEach(e=>e?.id&&examIds.add(e.id));
    (s.attempts||[]).forEach(a=>a?.examId&&examIds.add(a.examId));
    let ids=Array.from(examIds);
    if(currentSubjectFilter!=='all') ids=ids.filter(id=>getExamSubjectById(s,id)===currentSubjectFilter);
    const options=[{value:'all',label:'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}].concat(ids.sort((a,b)=>String(getExamTitleById(s,a)).localeCompare(String(getExamTitleById(s,b)),'th')).map(id=>({value:id,label:getExamTitleById(s,id)})));
    const prev=currentExamFilter;
    filterEl.innerHTML=options.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
    if(options.some(o=>o.value===prev)) filterEl.value=prev;
    else{currentExamFilter='all';filterEl.value='all';}
  }

  function rebuildSubjectOptions(s){
    if(!subjectEl) return;
    const subjects=new Set();
    (s.exams||[]).forEach(e=>subjects.add(e.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'));
    (s.attempts||[]).forEach(a=>subjects.add(a.examSubject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'));
    const opts=['all',...Array.from(subjects).filter(Boolean).sort((a,b)=>a.localeCompare(b,'th'))];
    subjectEl.innerHTML=opts.map(v=>`<option value="${v}">${v==='all'?'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':v}</option>`).join('');
    if(opts.includes(currentSubjectFilter)) subjectEl.value=currentSubjectFilter;
    else{currentSubjectFilter='all';subjectEl.value='all';}
  }

  // clone to remove old listeners
  const newFilterEl=filterEl.cloneNode(false);
  filterEl.parentNode.replaceChild(newFilterEl,filterEl);
  const newSubjectEl=subjectEl.cloneNode(false);
  subjectEl.parentNode.replaceChild(newSubjectEl,subjectEl);

  document.getElementById('statsFilterSubject').onchange=(e)=>{currentSubjectFilter=e.target.value||'all';currentExamFilter='all';document.getElementById('statsFilterExam').value='all';render();};
  document.getElementById('statsFilterExam').onchange=(e)=>{currentExamFilter=e.target.value||'all';render();};

  function openConfirm(aId){
    pendingDeleteAttemptId=aId;
    document.getElementById('statsConfirmText').textContent=`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏° (${aId})`;
    document.getElementById('statsConfirmOverlay').classList.add('show');
  }
  function closeConfirm(){pendingDeleteAttemptId=null;document.getElementById('statsConfirmOverlay').classList.remove('show');}

  document.getElementById('statsConfirmCancel').onclick=closeConfirm;
  document.getElementById('statsConfirmOverlay').onclick=(e)=>{if(e.target.id==='statsConfirmOverlay') closeConfirm();};
  document.getElementById('statsConfirmOk').onclick=()=>{
    if(!pendingDeleteAttemptId) return closeConfirm();
    const s=Store.load();
    s.attempts=(s.attempts||[]).filter(a=>a.id!==pendingDeleteAttemptId);
    Store.save(s);closeConfirm();render();
  };

  function render(){
    const s=Store.load();
    rebuildSubjectOptions(s);rebuildFilterOptions(s);
    const allAttempts=(s.attempts||[]).slice().sort((a,b)=>(b.startedAt||0)-(a.startedAt||0));
    const bySubject=currentSubjectFilter==='all'?allAttempts:allAttempts.filter(a=>(a.examSubject||getExamSubjectById(s,a.examId))===currentSubjectFilter);
    const attempts=currentExamFilter==='all'?bySubject:bySubject.filter(a=>a.examId===currentExamFilter);
    const rowsEl=document.getElementById('statsRows');
    if(!attempts.length){rowsEl.innerHTML=`<tr><td colspan="8" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)</td></tr>`;return;}
    rowsEl.innerHTML=attempts.map((a,idx)=>{
      const exam=(s.exams||[]).find(e=>e.id===a.examId);
      const examTitle=exam?.title||a.examTitle||'‚Äî';
      const examSubject=a.examSubject||exam?.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const takerName=a.takerName||'‚Äî';
      const started=a.startedAt?new Date(a.startedAt):null;
      const dateStr=started?started.toLocaleString('th-TH'):'‚Äî';
      const usedSec=Number.isFinite(a.usedSeconds)?a.usedSeconds:0;
      return `<tr>
        <td><b>${idx+1}</b></td>
        <td>${dateStr}<small>${a.id||''}</small></td>
        <td>${esc(takerName)}</td>
        <td>${esc(examSubject)}</td>
        <td>${esc(examTitle)}</td>
        <td><b>${a.score||0}/${a.total||0}</b></td>
        <td>${formatDuration(usedSec)}</td>
        <td><button class="btn-delete" data-del="${a.id}">‡∏•‡∏ö</button> <button class="btn" style="padding:6px 10px;font-size:12px;" data-review="${a.id}">‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢</button></td>
      </tr>`;
    }).join('');
    rowsEl.querySelectorAll('[data-del]').forEach(btn=>btn.addEventListener('click',()=>openConfirm(btn.getAttribute('data-del'))));
    rowsEl.querySelectorAll('[data-review]').forEach(btn=>btn.addEventListener('click',()=>navigate('review',{attemptId:btn.getAttribute('data-review')})));
  }

  document.getElementById('statsBtnExport').onclick=()=>{
    const s=Store.load();
    const payload=JSON.stringify({version:1,attempts:s.attempts||[]},null,2);
    const blob=new Blob([payload],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`stats_${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  };

  document.getElementById('statsFileImport').onchange=async(e)=>{
    const file=e.target.files&&e.target.files[0];
    if(!file) return;
    try{const text=await file.text();const data=JSON.parse(text);if(!data||!Array.isArray(data.attempts)) throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');const s=Store.load();s.attempts=data.attempts;Store.save(s);render();alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');}
    catch(err){alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err?.message||err));}
    finally{e.target.value='';}
  };

  document.getElementById('statsBtnClear').onclick=()=>{
    if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return;
    const s=Store.load();s.attempts=[];Store.save(s);render();
  };

  render();
}

// ===================== ADMIN PAGE =====================
function initAdmin(){
  const s=Store.init();
  let subjectFilter='';
  const subjFilterEl=document.getElementById('adminSubjFilter');

  document.getElementById('adminLoginBtn').onclick=()=>{s.adminLoggedIn=true;Store.save(s);toast('Logged in (demo)');renderAdmin();};
  document.getElementById('adminLogoutBtn').onclick=()=>{s.adminLoggedIn=false;Store.save(s);toast('Logged out (demo)');renderAdmin();};
  if(subjFilterEl) subjFilterEl.onchange=(e)=>{subjectFilter=e.target.value;renderAdmin();};

  function renderAdmin(){
    if(!s.adminLoggedIn){
      document.getElementById('adminGate').innerHTML=`<div class="card" style="padding:16px;"><div style="font-weight:900;">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô</div><div class="muted" style="margin-top:6px;">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Login ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô (‡πÄ‡∏î‡πÇ‡∏°)</div></div>`;
      document.getElementById('adminContent').style.display='none';
      return;
    }
    document.getElementById('adminGate').innerHTML='';
    document.getElementById('adminContent').style.display='block';

    const all=(s.exams||[]).slice().sort((a,b)=>((a.order??0)-(b.order??0))||((a.uploadedAt??0)-(b.uploadedAt??0)));
    const subjects=Array.from(new Set(all.map(e=>(e.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')))).sort((a,b)=>a.localeCompare(b,'th'));
    if(subjFilterEl){
      subjFilterEl.innerHTML=`<option value="">‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</option>${subjects.map(sub=>`<option value="${esc(sub)}" ${sub===subjectFilter?'selected':''}>${esc(sub)}</option>`).join('')}`;
    }

    const list=subjectFilter?all.filter(e=>(e.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')===subjectFilter):all;
    const fmtDate=(ts)=>{if(!ts) return '-';try{return new Date(ts).toLocaleString('th-TH');}catch{return '-';}};
    const tb=document.getElementById('adminTbody');tb.innerHTML='';
    list.forEach((e,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td style="font-weight:900;">${esc(e.title)}</td>
        <td>${esc(e.subject||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')}</td>
        <td><div style="display:flex;flex-direction:column;gap:6px;"><button class="btn" style="padding:6px 10px;" data-move="up" data-id="${e.id}" ${idx===0?'disabled':''}>‚ñ≤</button><button class="btn" style="padding:6px 10px;" data-move="down" data-id="${e.id}" ${idx===list.length-1?'disabled':''}>‚ñº</button></div></td>
        <td><div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;"><span class="badge ${e.published?'ok':'warn'}">${e.published?'‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà':'‡∏ã‡πà‡∏≠‡∏ô'}</span><select class="statusSel" data-status="${e.id}" style="padding:6px 10px;border:1px solid var(--border);border-radius:12px;background:#fff;"><option value="published" ${e.published?'selected':''}>‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option><option value="hidden" ${!e.published?'selected':''}>‡∏ã‡πà‡∏≠‡∏ô</option></select></div></td>
        <td>${e.questionCount}</td>
        <td class="muted">${fmtDate(e.uploadedAt)}</td>
        <td class="muted" style="max-width:260px;word-break:break-all;">${esc(e.pdfUrl)}</td>
        <td><button class="btn" data-edit="${e.id}">‡πÄ‡∏õ‡∏¥‡∏î Editor</button></td>
        <td><button class="btn" style="border-color:#ef4444;color:#b91c1c;" data-del="${e.id}">‡∏•‡∏ö</button></td>
      `;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('[data-status]').forEach(sel=>{
      sel.addEventListener('change',()=>{
        const id=sel.getAttribute('data-status');const exam=s.exams.find(x=>x.id===id);if(!exam) return;
        exam.published=(sel.value==='published');Store.save(s);toast(exam.published?'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÅ‡∏•‡πâ‡∏ß':'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß');renderAdmin();
      });
    });
    tb.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id=btn.getAttribute('data-del');const exam=s.exams.find(x=>x.id===id);if(!exam) return;
        if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${exam.title}"?`)) return;
        s.exams=s.exams.filter(x=>x.id!==id);
        if(s.questions&&s.questions[id]) delete s.questions[id];
        Store.save(s);toast('‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß');renderAdmin();
      });
    });
    tb.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.addEventListener('click',()=>navigate('admin_editor',{id:btn.getAttribute('data-edit')}));
    });
    tb.querySelectorAll('[data-move]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id=btn.getAttribute('data-id'),dir=btn.getAttribute('data-move');
        s.exams.forEach((ex,idx)=>{if(typeof ex.order!=='number') ex.order=idx+1;});
        const sorted=s.exams.slice().sort((a,b)=>((a.order??0)-(b.order??0))||((a.uploadedAt??0)-(b.uploadedAt??0)));
        const i=sorted.findIndex(x=>x.id===id);if(i<0) return;
        const j=dir==='up'?i-1:i+1;if(j<0||j>=sorted.length) return;
        const tmp=sorted[i].order;sorted[i].order=sorted[j].order;sorted[j].order=tmp;
        Store.save(s);renderAdmin();
      });
    });
  }

  renderAdmin();
}

// ===================== ADMIN NEW PAGE =====================
function initAdminNew(){
  const s=Store.init();
  if(!s.adminLoggedIn){navigate('admin');return;}

  let lastUploadedPdfKey=null;
  const pdfFileEl=document.getElementById('newPdfFile');
  const pdfUrlEl=document.getElementById('newPdfUrl');

  // reset file input
  if(pdfFileEl) pdfFileEl.value='';

  const newPdfFileEl=pdfFileEl.cloneNode(true);
  pdfFileEl.parentNode.replaceChild(newPdfFileEl,pdfFileEl);
  newPdfFileEl.addEventListener('change',async(e)=>{
    try{
      const f=e.target.files&&e.target.files[0];
      if(!f) return;
      if(f.type&&f.type!=='application/pdf'){toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF');return;}
      const key=`pdf_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      await PdfDB.put(key,f);
      lastUploadedPdfKey=key;
      pdfUrlEl.value=`localpdf:${key}`;
      toast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)');
    }catch(err){toast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err?.message||err));}
  });

  const createBtn=document.getElementById('newCreateBtn');
  const newCreateBtn=createBtn.cloneNode(true);
  createBtn.parentNode.replaceChild(newCreateBtn,createBtn);
  newCreateBtn.addEventListener('click',()=>{
    const title=document.getElementById('newTitle').value.trim()||'Exam ‡πÉ‡∏´‡∏°‡πà';
    const subject=document.getElementById('newSubject').value.trim();
    const minutes=Math.max(1,Number(document.getElementById('newMinutes').value||45));
    const published=document.getElementById('newPublished').value==='true';
    const pdfUrl=document.getElementById('newPdfUrl').value.trim();
    const createPlaceholder=document.getElementById('newCreatePlaceholder').checked;
    const qCount=Math.min(999,Math.max(1,Math.floor(Number(document.getElementById('newQCount').value||50))));
    if(!subject) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤');
    const maxOrder=Math.max(0,...(s.exams||[]).map(e=>(typeof e.order==='number'?e.order:0)));
    const id='exam_'+Math.random().toString(16).slice(2);
    s.exams.unshift({id,subject,title,durationSeconds:Math.round(minutes*60),published,pdfUrl,questionCount:createPlaceholder?qCount:0,uploadedAt:Date.now(),order:maxOrder+1});
    s.questions[id]=createPlaceholder?Array.from({length:qCount}).map((_,i)=>({id:'q'+(i+1),number:i+1,no:i+1,page:Math.max(1,Math.ceil((i+1)/5)),choices:{A:'',B:'',C:'',D:''},correct:'A'})):[];
    // apply excel data ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if(window._newExcelData && window._newExcelData.length > 0){
      window._newExcelData.forEach(row=>{
        const q=s.questions[id].find(q=>(q.number||q.no)===row.no);
        if(q){ q.page=row.page; q.correct=row.correct; }
      });
      window._newExcelData=null;
    }
    Store.save(s);toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    setTimeout(()=>navigate('admin_editor',{id}),400);
  });
}

// ===================== ADMIN EDITOR PAGE =====================
function initEditor(examId){
  const s=Store.init();
  if(!s.adminLoggedIn){navigate('admin');return;}
  const exam=s.exams.find(e=>e.id===examId);
  if(!exam){navigate('admin');return;}

  // normalize
  const list=(s.questions[examId]||[]).map(q=>({...q, no:q.no??q.number??0}));

  document.getElementById('editorTitle').textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö: '+exam.title;
  document.getElementById('editorMeta').textContent=`‡πÄ‡∏ß‡∏•‡∏≤ ${Math.round(exam.durationSeconds/60)} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ PDF: ${exam.pdfUrl} ‚Ä¢ ‡∏ß‡∏¥‡∏ä‡∏≤: ${exam.subject||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}`;

  const titleInput=document.getElementById('editorExamTitle');
  const renameBtn=document.getElementById('editorRenameBtn');
  if(titleInput) titleInput.value=exam.title||'';

  function applyRename(){
    const v=(titleInput?.value||'').trim();
    if(!v){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö');titleInput?.focus?.();return;}
    exam.title=v;Store.save(s);
    document.getElementById('editorTitle').textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö: '+exam.title;
    toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
  }
  renameBtn.onclick=(e)=>{e.preventDefault();applyRename();};
  titleInput.onkeydown=(e)=>{if(e.key==='Enter'){e.preventDefault();applyRename();}};

  const subjectInput=document.getElementById('editorExamSubject');
  const subjectBtn=document.getElementById('editorSubjectBtn');
  if(subjectInput) subjectInput.value=exam.subject||'';

  function applySubject(){
    const v=(subjectInput?.value||'').trim()||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
    exam.subject=v;Store.save(s);
    document.getElementById('editorMeta').textContent=`‡πÄ‡∏ß‡∏•‡∏≤ ${Math.round(exam.durationSeconds/60)} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ PDF: ${exam.pdfUrl} ‚Ä¢ ‡∏ß‡∏¥‡∏ä‡∏≤: ${exam.subject||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}`;
    toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
  }
  subjectBtn.onclick=(e)=>{e.preventDefault();applySubject();};
  subjectInput.onkeydown=(e)=>{if(e.key==='Enter'){e.preventDefault();applySubject();}};

  let selectedIndex=0;
  const refs={};
  const fieldOrder=['page','correct'];

  function select(i){selectedIndex=Math.max(0,Math.min(list.length-1,i));highlight();}
  function highlight(){[...document.getElementById('editorTbody').children].forEach((tr,idx)=>{tr.className=idx===selectedIndex?'rowActive':'';}); }
  function focusField(ri,field){const el=refs[`${ri}:${field}`];if(el&&el.focus) el.focus();}
  function nextField(ri,field){const i=fieldOrder.indexOf(field);if(i<fieldOrder.length-1) return{rowIndex:ri,field:fieldOrder[i+1]};return{rowIndex:Math.min(ri+1,list.length-1),field:'page'};}
  function prevField(ri,field){const i=fieldOrder.indexOf(field);if(i>0) return{rowIndex:ri,field:fieldOrder[i-1]};return{rowIndex:Math.max(ri-1,0),field:'correct'};}
  function onFastKey(e,ri,field){
    if(!document.getElementById('editorFast').checked) return;
    if(e.key==='Enter'||e.key==='Tab'){e.preventDefault();const back=e.shiftKey;const t=back?prevField(ri,field):nextField(ri,field);select(t.rowIndex);requestAnimationFrame(()=>focusField(t.rowIndex,t.field));}
  }

  function renderTable(){
    const tbody=document.getElementById('editorTbody');
    tbody.innerHTML='';
    // clear refs
    Object.keys(refs).forEach(k=>delete refs[k]);
    list.forEach((q,idx)=>{
      const tr=document.createElement('tr');
      tr.addEventListener('click',()=>select(idx));
      tr.innerHTML=`<td style="font-weight:900;">${q.number||q.no}</td><td><input type="number" min="1" value="${q.page}" data-field="page" /></td><td><div class="correctBtns" data-field="correct"><button type="button" class="correctBtn" data-val="A">‡∏Å</button><button type="button" class="correctBtn" data-val="B">‡∏Ç</button><button type="button" class="correctBtn" data-val="C">‡∏Ñ</button><button type="button" class="correctBtn" data-val="D">‡∏á</button></div></td>`;
      const correctVal = q.correct||'A';
      tr.querySelectorAll('.correctBtn').forEach(btn=>{
        if(btn.getAttribute('data-val')===correctVal) btn.classList.add('selected');
        btn.addEventListener('click',(e)=>{
          e.stopPropagation();
          select(idx);
          tr.querySelectorAll('.correctBtn').forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
          q.correct=btn.getAttribute('data-val');
        });
      });
      const pageInput = tr.querySelector('input[data-field="page"]');
      refs[`${idx}:page`]=pageInput;
      pageInput.addEventListener('focus',()=>select(idx));
      pageInput.addEventListener('keydown',(e)=>onFastKey(e,idx,'page'));
      pageInput.addEventListener('input',()=>{ q.page=Math.max(1,Number(pageInput.value||1)); });
      tbody.appendChild(tr);
    });
    select(selectedIndex);
  }
  renderTable();

  document.getElementById('editorSave').onclick=()=>{
    s.questions[examId]=list;Store.save(s);toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
  };

  // bind excel import ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö editor
  bindEditorExcel(examId, list, renderTable);
}

// ===================== EXCEL TEMPLATE DOWNLOAD =====================
function downloadExcelTemplate(qCount, filename) {
  if (typeof XLSX === 'undefined') { alert('SheetJS ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà'); return; }

  // header row
  const rows = [['‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà', '‡∏´‡∏ô‡πâ‡∏≤ PDF', '‡πÄ‡∏â‡∏•‡∏¢ (‡∏Å/‡∏Ç/‡∏Ñ/‡∏á)']];

  // data rows ‚Äî ‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å ‡πÑ‡∏ß‡πâ‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠ ‡∏´‡∏ô‡πâ‡∏≤ PDF ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 5 ‡∏Ç‡πâ‡∏≠
  for (let i = 1; i <= qCount; i++) {
    rows.push([i, Math.max(1, Math.ceil(i / 5)), '‡∏Å']);
  }

  const ws = XLSX.utils.aoa_to_sheet(rows);

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á column
  ws['!cols'] = [{ wch: 10 }, { wch: 12 }, { wch: 20 }];

  // style header (SheetJS community ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà basic)
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '‡πÄ‡∏â‡∏•‡∏¢');
  XLSX.writeFile(wb, filename || 'template_‡πÄ‡∏â‡∏•‡∏¢.xlsx');
}

// bind ‡∏õ‡∏∏‡πà‡∏° admin_new
(function bindNewTemplate() {
  const btn = document.getElementById('newDownloadTemplate');
  if (!btn) return;
  btn.addEventListener('click', () => {
    const qCount = Math.max(1, parseInt(document.getElementById('newQCount')?.value || 50));
    const title = (document.getElementById('newTitle')?.value || 'exam').trim().replace(/\s+/g, '_');
    downloadExcelTemplate(qCount, `template_${title}.xlsx`);
  });
})();

// ===================== EXCEL IMPORT =====================

// ‡πÅ‡∏õ‡∏•‡∏á ‡∏Å/‡∏Ç/‡∏Ñ/‡∏á ‡∏´‡∏£‡∏∑‡∏≠ A/B/C/D ‚Üí A/B/C/D
function normalizeAnswer(v) {
  if (!v) return null;
  const s = String(v).trim().toUpperCase();
  const map = {'‡∏Å':'A','‡∏Ç':'B','‡∏Ñ':'C','‡∏á':'D'};
  if (map[String(v).trim()]) return map[String(v).trim()];
  if (['A','B','C','D'].includes(s)) return s;
  return null;
}

// ‡∏≠‡πà‡∏≤‡∏ô Excel/CSV ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô array [{no, page, correct}]
function parseExcelFile(file) {
  return new Promise((resolve, reject) => {
    if (typeof XLSX === 'undefined') {
      reject(new Error('SheetJS ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'));
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô header ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤
        // ‡∏ñ‡πâ‡∏≤ col A ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‚Üí ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô header ‡∏Ç‡πâ‡∏≤‡∏°
        let startRow = 0;
        if (rows.length > 0) {
          const firstVal = String(rows[0][0] || '').trim();
          if (isNaN(Number(firstVal)) || firstVal === '') startRow = 1;
        }

        const result = [];
        for (let i = startRow; i < rows.length; i++) {
          const row = rows[i];
          const no = parseInt(row[0]);
          const page = parseInt(row[1]) || 1;
          const correct = normalizeAnswer(row[2]);
          if (!isNaN(no) && no > 0 && correct) {
            result.push({ no, page, correct });
          }
        }
        resolve(result);
      } catch(err) {
        reject(err);
      }
    };
    reader.onerror = () => reject(new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'));
    reader.readAsArrayBuffer(file);
  });
}

// ‚îÄ‚îÄ admin_new: bind excel input ‚îÄ‚îÄ
(function bindNewExcel() {
  const input = document.getElementById('newExcelFile');
  const status = document.getElementById('newExcelStatus');
  const preview = document.getElementById('newExcelPreview');
  if (!input) return;

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà parse ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô closure ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô create
  window._newExcelData = null;

  input.addEventListener('change', async () => {
    const file = input.files[0];
    if (!file) return;
    status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô...';
    preview.style.display = 'none';
    try {
      const data = await parseExcelFile(file);
      if (data.length === 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà valid ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
      window._newExcelData = data;
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï qCount ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö excel
      const qCountEl = document.getElementById('newQCount');
      if (qCountEl) qCountEl.value = data.length;
      status.textContent = '';
      preview.style.display = 'block';
      preview.textContent = `‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.length} ‡∏Ç‡πâ‡∏≠ ‚Äî ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏Ç‡πâ‡∏≠${data[0].no} ‡∏´‡∏ô‡πâ‡∏≤${data[0].page} ‡πÄ‡∏â‡∏•‡∏¢${data[0].correct}`;
    } catch(err) {
      window._newExcelData = null;
      status.textContent = '‚ùå ' + err.message;
      preview.style.display = 'none';
    }
  });
})();

// ‚îÄ‚îÄ admin_editor: bind excel input ‚îÄ‚îÄ
function bindEditorExcel(examId, list, renderFn) {
  // bind template download
  const dlBtn = document.getElementById('editorDownloadTemplate');
  if (dlBtn) {
    const newDlBtn = dlBtn.cloneNode(true);
    dlBtn.parentNode.replaceChild(newDlBtn, dlBtn);
    newDlBtn.addEventListener('click', () => {
      downloadExcelTemplate(list.length, `template_‡πÄ‡∏â‡∏•‡∏¢_${examId}.xlsx`);
    });
  }

  const input = document.getElementById('editorExcelFile');
  const status = document.getElementById('editorExcelStatus');
  if (!input) return;

  // remove old listener
  const newInput = input.cloneNode(true);
  input.parentNode.replaceChild(newInput, input);

  newInput.addEventListener('change', async () => {
    const file = newInput.files[0];
    if (!file) return;
    status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô...';
    try {
      const data = await parseExcelFile(file);
      if (data.length === 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà valid ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');

      // merge ‡πÄ‡∏Ç‡πâ‡∏≤ list
      let updated = 0;
      data.forEach(row => {
        const q = list.find(q => (q.number || q.no) === row.no);
        if (q) {
          q.page = row.page;
          q.correct = row.correct;
          updated++;
        }
      });
      // re-render table
      if (renderFn) renderFn();
      status.textContent = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${updated} ‡∏Ç‡πâ‡∏≠`;
      toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${updated} ‡∏Ç‡πâ‡∏≠`);
    } catch(err) {
      status.textContent = '‚ùå ' + err.message;
    }
  });
}

// ===================== INIT =====================
Store.init();
navigate('home');
</script>
</body>
</html>
